version: "3.8"

x-common-env: &common-env
  SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
  SPRING_CLOUD_CONFIG_URI: ${SPRING_CLOUD_CONFIG_URI}
  SPRING_CLOUD_CONFIG_FAILFAST: "false"
  EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: ${EUREKA_CLIENT_SERVICEURL_DEFAULTZONE}
  JWT_SECRET: ${JWT_SECRET}

x-db-env: &db-env
  SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL}
  SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME}
  SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD}

services:

  config-service:
    build:
      context: ./configservice
      dockerfile: docker/Dockerfile
    env_file: [.env]
    environment:
      SPRING_APPLICATION_NAME: configservice
      SERVER_PORT: ${PORT_CONFIG}          # 8081
      SPRING_PROFILES_ACTIVE: native
      SPRING_CLOUD_CONFIG_SERVER_NATIVE_SEARCH_LOCATIONS: file:/config-data
      JAVA_TOOL_OPTIONS: ${JAVA_TOOL_OPTIONS_SMALL}
    volumes:
      - ./config-data:/config-data:ro
    restart: unless-stopped
    networks: [backend-net]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:${PORT_CONFIG}/actuator/health | grep -q '\"status\"'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 25s

  eureka-service:
    build:
      context: ./eurekaservice
      dockerfile: docker/Dockerfile
    env_file: [.env]
    depends_on:
      config-service:
        condition: service_healthy
    environment:
      SPRING_APPLICATION_NAME: msvc-eureka
      SERVER_PORT: ${PORT_EUREKA}          # 8761
      <<: *common-env
      JAVA_TOOL_OPTIONS: ${JAVA_TOOL_OPTIONS_SMALL}
    restart: unless-stopped
    networks: [backend-net]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:${PORT_EUREKA}/actuator/health | grep -q '\"status\"' || curl -fsS http://localhost:${PORT_EUREKA}/ | grep -qi eureka"]
      interval: 10s
      timeout: 5s
      retries: 25
      start_period: 35s

  gateway-service:
    build:
      context: ./gatewayservice
      dockerfile: docker/Dockerfile
    env_file: [.env]
    ports:
      - "80:${PORT_GATEWAY}"               # 80 -> 8080
    depends_on:
      config-service:
        condition: service_healthy
      eureka-service:
        condition: service_healthy
    environment:
      SPRING_APPLICATION_NAME: msvc-gateway
      SERVER_PORT: ${PORT_GATEWAY}         # 8080
      <<: *common-env
      JAVA_TOOL_OPTIONS: ${JAVA_TOOL_OPTIONS_GATEWAY}
    restart: unless-stopped
    networks: [backend-net]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:${PORT_GATEWAY}/actuator/health | grep -q '\"status\"'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 25s

  users-service:
    build:
      context: ./userservice
      dockerfile: docker/Dockerfile
    env_file: [.env]
    depends_on:
      config-service:
        condition: service_healthy
      eureka-service:
        condition: service_healthy
    environment:
      SPRING_APPLICATION_NAME: msvc-users
      SERVER_PORT: ${PORT_USERS}           # 8004
      <<: *common-env
      <<: *db-env
      JAVA_TOOL_OPTIONS: ${JAVA_TOOL_OPTIONS_SMALL}
    volumes:
      - ./certs:/certs:ro
    restart: unless-stopped
    networks: [backend-net]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:${PORT_USERS}/actuator/health | grep -q '\"status\"'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 25s

  products-service:
    build:
      context: ./productservice
      dockerfile: docker/Dockerfile
    env_file: [.env]
    depends_on:
      config-service:
        condition: service_healthy
      eureka-service:
        condition: service_healthy
    environment:
      SPRING_APPLICATION_NAME: msvc-products
      SERVER_PORT: ${PORT_PRODUCTS}        # 8001
      <<: *common-env
      <<: *db-env
      JAVA_TOOL_OPTIONS: ${JAVA_TOOL_OPTIONS_SMALL}
    volumes:
      - ./certs:/certs:ro
    restart: unless-stopped
    networks: [backend-net]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:${PORT_PRODUCTS}/actuator/health | grep -q '\"status\"'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 25s

  orders-service:
    build:
      context: ./orderservice
      dockerfile: docker/Dockerfile
    env_file: [.env]
    depends_on:
      config-service:
        condition: service_healthy
      eureka-service:
        condition: service_healthy
    environment:
      SPRING_APPLICATION_NAME: msvc-orders
      SERVER_PORT: ${PORT_ORDERS}          # 8002
      <<: *common-env
      <<: *db-env
      JAVA_TOOL_OPTIONS: ${JAVA_TOOL_OPTIONS_SMALL}
    volumes:
      - ./certs:/certs:ro
    restart: unless-stopped
    networks: [backend-net]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:${PORT_ORDERS}/actuator/health | grep -q '\"status\"'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 25s

  payment-service:
    build:
      context: ./paymentservice
      dockerfile: docker/Dockerfile
    env_file: [.env]
    depends_on:
      config-service:
        condition: service_healthy
      eureka-service:
        condition: service_healthy
    environment:
      SPRING_APPLICATION_NAME: msvc-pay
      SERVER_PORT: ${PORT_PAY}             # 8003
      <<: *common-env
      <<: *db-env
      JAVA_TOOL_OPTIONS: ${JAVA_TOOL_OPTIONS_SMALL}
    volumes:
      - ./certs:/certs:ro
    restart: unless-stopped
    networks: [backend-net]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:${PORT_PAY}/actuator/health | grep -q '\"status\"'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 25s

networks:
  backend-net:
    driver: bridge